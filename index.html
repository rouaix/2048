<!DOCTYPE html>
<html>

<head>
    <title>Jeu 2048</title>
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/animate.css" />
</head>

<body>
    <nav id="bandeau">
        <img src="./img/2121.png" id="logo" alt="" title="Commencer une partie !" onclick="return lancerJeu();" class="animated bounce">
        <p>
            <label for="taille">Taille de la grille </label><br />
            <input type="number" name="lataille" id="lataille" value="4" max="8" min="4" onchange="changeTaille();" /><br />
            <i>Changez la taille et cliquez sur le smiley.</i>
        </p>
        
    </nav>
    <div id="plateau"></div>
    <h2>Score :
        <span id="score"></span>
    </h2>
    <p><strong>Comment jouer:</strong><br />Utilisez le clavier pour faire bouger les cases et obtenir le chiffre 2048.</p>


    <script type="text/javascript">
        <!--
        // Taille de la grille
        let taille = document.getElementById("lataille").value;
        var min = 0;
        var max = taille - 1;

        var sens = "";

        var dejaFait = false;
        var score = 0;

        var exclureIds = [];

        function changeTaille(){
            taille = document.getElementById("lataille").value;
            if (taille >8){taille = 8;}
            window.location.reload();
            return true;
        }
            
        function lancerJeu() {
            //alert("lancerJeu");
            //Load the table
            //changeTaille();
            var html = '<table>';
            for (var ligne = 0; ligne < taille; ligne++) {
                html += '<tr>';
                for (var colonne = 0; colonne < taille; colonne++) {
                    var id = ligne + "" + colonne;
                    html += '<td align="center" valign="center" id="' + id + '" class="fond"></td>';
                }
                html += '</tr>';
            }
            html += '</table>';
            //alert(html);
            document.getElementById("plateau").innerHTML = html;

            var id1 = getId();
            var id2 = "";
            while (true) {
                id2 = getId();
                if (id1 != id2)
                    break;
            }
            //Set initial 2 values
            document.getElementById(id1).innerHTML = "2";
            document.getElementById(id2).innerHTML = "2";

            document.getElementById(id1).style.backgroundColor = choixCouleur(2);
            document.getElementById(id2).style.backgroundColor = choixCouleur(2);

            //document.getElementById(id1).style.className = "fraise";
            //document.getElementById(id2).style.className = "animated shake";

            score = 0;
            document.getElementById("score").innerHTML = score;

            return false;
        }

        function getRandom() {
            return Math.floor(Math.random() * (max - min + 1) + min);
        }

        function getId() {
            var i = getRandom();
            var j = getRandom();
            return i + "" + j;
        }

        function up() {
            dejaFait = false;
            exclureIds = [];
            for (var j = min; j <= max; j++) {
                for (var i = min; i <= max; i++) {
                    var id = i + "" + j;
                    if (document.getElementById(id).innerHTML != "") {
                        moveUp(id);
                    }
                }
            }
            if (dejaFait == true) {
                miseAJour();
                fond();
            }
            return false;
        }

        function left() {
            dejaFait = false;
            exclureIds = [];
            for (var i = min; i <= max; i++) {
                for (var j = min; j <= max; j++) {
                    var id = i + "" + j;
                    if (document.getElementById(id).innerHTML != "") {
                        moveLeft(id);
                    }
                }
            }
            if (dejaFait == true) {
                miseAJour();
                fond();
            }
            return false;
        }


        function down() {
            dejaFait = false;
            exclureIds = [];
            for (var i = min; i <= max; i++) {
                for (var j = max; j >= min; j--) {
                    var id = j + "" + i;
                    if (document.getElementById(id).innerHTML != "") {
                        moveDown(id);
                    }
                }
            }
            if (dejaFait == true) {
                miseAJour();
                fond();
            }
            return false;
        }

        function right() {
            dejaFait = false;
            exclureIds = [];
            for (var i = min; i <= max; i++) {
                for (var j = max; j >= min; j--) {
                    var id = i + "" + j;
                    if (document.getElementById(id).innerHTML != "") {
                        moveRight(id);
                    }
                }
            }
            if (dejaFait == true) {
                miseAJour();
                fond();
            }
            return false;
        }

        function miseAJour() {
            //Add new value
            var ids = [];
            for (var i = min; i <= max; i++) {
                for (var j = min; j <= max; j++) {
                    var id = i + "" + j;
                    verifer_valeur(id);
                    if (document.getElementById(id).innerHTML == "") {
                        ids.push(id);                        
                    }
                }
            }
            var id = ids[Math.floor(Math.random() * ids.length)];

            document.getElementById(id).innerHTML = "2";
            document.getElementById(id).style.backgroundColor = choixCouleur(2);

            //Check if no move space available
            var allFilled = true;
            for (var i = min; i <= max; i++) {
                for (var j = min; j <= max; j++) {
                    var id = i + "" + j;
                    verifer_valeur(id);
                    if (document.getElementById(id).innerHTML == "") {
                        allFilled = false; 
                        document.getElementById(id).className = "fond";
                        break;
                    }
                }
            }

            //Update score
            document.getElementById("score").innerHTML = score;
            if (allFilled) {
                checkGameOver();
            }
        }

        function verifer_valeur(id){
            var laclasse = document.getElementById(id);
            var z = document.getElementById(id).textContent;
            
            if (z > 32){                
                laclasse.className = "fraise";
            }else{
                laclasse.className = "fond";
            }
        }
        
        function fond(){
            //sleep(1000);
            for (var i = min; i <= max; i++) {
                for (var j = min; j <= max; j++) {
                    var id = i + "" + j;
                    //document.getElementById(id).className = "fond";
                }
            }
        }

        function sleep(milliSeconds){
                var startTime = new Date().getTime();
                while (new Date().getTime() < startTime + milliSeconds);
        }
        
        function checkGameOver() {
            var isOver = true;
            for (var j = min; j <= max; j++) {
                for (var i = min; i <= (max - 1); i++) {
                    //alert(i+" "+j);
                    var val = parseInt(document.getElementById(i + "" + j).innerHTML);
                    var nVal = parseInt(document.getElementById((i + 1) + "" + j).innerHTML);
                    if (val == nVal) {
                        isOver = false;
                        break;
                    }
                }
            }

            if (isOver == true) {
                for (var i = min; i <= max; i++) {
                    for (var j = min; j <= (max - 1); j++) {
                        //alert(i+" "+j);
                        var val = parseInt(document.getElementById(i + "" + j).innerHTML);
                        var nVal = parseInt(document.getElementById(i + "" + (j + 1)).innerHTML);
                        if (val == nVal) {
                            isOver = false;
                            break;
                        }
                    }
                }
            }

            if (isOver) {
                alert("Game over!");
            }

            return false;
        }

        function choixCouleur(val) {
            var color = "#ffffff";
            switch (val) {
                case 2:
                    color = "#f5ebb2";
                    break;
                case 4:
                    color = "#f5cfaf";
                    break;
                case 8:
                    color = "#bacaf5";
                    break;
                case 16:
                    color = "#e5aeb9";
                    break;
                case 32:
                    color = "#8294ca";
                    break;
                case 64:
                    color = "#d4a4c8";
                    break;
                case 128:
                    color = "#a5e0e1";
                    break;
                case 256:
                    color = "#b9f7de";
                    break;
                case 512:
                    color = "#e1cbf7";
                    break;
                case 1024:
                    color = "#fa565f";
                    break;
                case 2048:
                    color = "#45cacd";
                    break;
                default:
                    color = "#ffffff";
            }
            return color;
        }

        if (typeof String.prototype.startsWith != 'function') {
            String.prototype.startsWith = function(str) {
                return this.substring(0, str.length) === str;
            }
        };
        if (typeof String.prototype.endsWith != 'function') {
            String.prototype.endsWith = function(str) {
                return this.substring(this.length - str.length, this.length) === str;
            }
        };

        document.onkeydown = function(e) {
            e.preventDefault(); //to prevent scroll of screen
            switch (e.keyCode) {
                case 37:
                    left();
                    break;
                case 38:
                    up();
                    break;
                case 39:
                    right();
                    break;
                case 40:
                    down();
                    break;
            }
        };


        function moveUp(id) {
            if (!id.startsWith(min)) {
                var arr = id.split("");
                var i = parseInt(arr[0]);
                var j = parseInt(arr[1]);
                for (var k = (i - 1); k >= min; k--) {
                    var nId = k + "" + j;
                    if (document.getElementById(nId).innerHTML != "") {
                        var val = parseInt(document.getElementById((k + 1) + "" + j).innerHTML);
                        var nVal = parseInt(document.getElementById(nId).innerHTML);
                        if (val == nVal) {
                            if (exclureIds.indexOf(nId) == -1) {
                                exclureIds.push(nId);
                                document.getElementById(nId).innerHTML = (val + nVal);
                                document.getElementById(nId).style.backgroundColor = choixCouleur((val + nVal));
                                document.getElementById((k + 1) + "" + j).innerHTML = "";
                                document.getElementById((k + 1) + "" + j).style.backgroundColor = "#444444";
                                dejaFait = true;
                                score += (val + nVal);
                            }
                            break;
                        }
                    } else {
                        document.getElementById(nId).innerHTML = document.getElementById((k + 1) + "" + j).innerHTML;
                        document.getElementById(nId).style.backgroundColor = document.getElementById((k + 1) + "" + j).style.backgroundColor;
                        document.getElementById((k + 1) + "" + j).innerHTML = "";
                        document.getElementById((k + 1) + "" + j).style.backgroundColor = "#444444";
                        dejaFait = true;
                    }
                }
            }
            return false;
        }

        function moveRight(id) {
            if (!id.endsWith(max)) {

                var arr = id.split("");
                var boucle = 0;

                var x = parseInt(arr[0]);
                var y = parseInt(arr[1]);

                for (var boucle = (y + 1); boucle <= max; boucle++) {
                    var nId = x + "" + boucle;
                    if (document.getElementById(nId).innerHTML != "") {
                        var val = parseInt(document.getElementById(x + "" + (boucle - 1)).innerHTML);
                        var nVal = parseInt(document.getElementById(nId).innerHTML);
                        if (val == nVal) {
                            if (exclureIds.indexOf(nId) == -1) {
                                exclureIds.push(nId);
                                document.getElementById(nId).innerHTML = (val + nVal);
                                document.getElementById(nId).style.backgroundColor = choixCouleur((val + nVal));
                                document.getElementById(x + "" + (boucle - 1)).innerHTML = "";
                                document.getElementById(x + "" + (boucle - 1)).style.backgroundColor = "#444444";
                                dejaFait = true;
                                score += (val + nVal);
                            }
                            break;
                        }
                    } else {
                        document.getElementById(nId).innerHTML = document.getElementById(x + "" + (boucle - 1)).innerHTML;
                        document.getElementById(nId).style.backgroundColor = document.getElementById(x + "" + (boucle - 1)).style.backgroundColor;
                        document.getElementById(x + "" + (boucle - 1)).innerHTML = "";
                        document.getElementById(x + "" + (boucle - 1)).style.backgroundColor = "#444444";
                        dejaFait = true;
                    }
                }
            }
            return false;
        }

        function moveDown(id) {
            if (!id.startsWith(max)) {
                var arr = id.split("");
                var i = parseInt(arr[0]);
                var j = parseInt(arr[1]);
                for (var k = (i + 1); k <= max; k++) {
                    var nId = k + "" + j;
                    if (document.getElementById(nId).innerHTML != "") {
                        var val = parseInt(document.getElementById((k - 1) + "" + j).innerHTML);
                        var nVal = parseInt(document.getElementById(nId).innerHTML);
                        if (val == nVal) {
                            if (exclureIds.indexOf(nId) == -1) {
                                exclureIds.push(nId);
                                document.getElementById(nId).innerHTML = (val + nVal);
                                document.getElementById(nId).style.backgroundColor = choixCouleur((val + nVal));
                                document.getElementById((k - 1) + "" + j).innerHTML = "";
                                document.getElementById((k - 1) + "" + j).style.backgroundColor = "#444444";
                                verifer_valeur(id);
                                dejaFait = true;
                                score += (val + nVal);
                            }
                            break;
                        }
                    } else {
                        document.getElementById(nId).innerHTML = document.getElementById((k - 1) + "" + j).innerHTML;
                        document.getElementById(nId).style.backgroundColor = document.getElementById((k - 1) + "" + j).style.backgroundColor;
                        document.getElementById((k - 1) + "" + j).innerHTML = "";
                        document.getElementById((k - 1) + "" + j).style.backgroundColor = "#444444";
                        dejaFait = true;
                    }
                }
            }
            return false;
        }

        function moveLeft(id) {
            if (!id.endsWith(min)) {
                var arr = id.split("");
                var i = parseInt(arr[0]);
                var j = parseInt(arr[1]);
                for (var k = (j - 1); k >= min; k--) {
                    var nId = i + "" + k;
                    if (document.getElementById(nId).innerHTML != "") {
                        var val = parseInt(document.getElementById(i + "" + (k + 1)).innerHTML);
                        var nVal = parseInt(document.getElementById(nId).innerHTML);
                        if (val == nVal) {
                            if (exclureIds.indexOf(nId) == -1) {
                                exclureIds.push(nId);
                                document.getElementById(nId).innerHTML = (val + nVal);
                                document.getElementById(nId).style.backgroundColor = choixCouleur((val + nVal));
                                document.getElementById(i + "" + (k + 1)).innerHTML = "";
                                document.getElementById(i + "" + (k + 1)).style.backgroundColor = "#444444";
                                dejaFait = true;
                                score += (val + nVal);
                            }
                            break;
                        }
                    } else {
                        document.getElementById(nId).innerHTML = document.getElementById(i + "" + (k + 1)).innerHTML;
                        document.getElementById(nId).style.backgroundColor = document.getElementById(i + "" + (k + 1)).style.backgroundColor;
                        document.getElementById(i + "" + (k + 1)).innerHTML = "";
                        document.getElementById(i + "" + (k + 1)).style.backgroundColor = "#444444";
                        dejaFait = true;
                    }
                }
            }
            return false;
        }

    
        //calling lancerJeu method
        lancerJeu();
        //-->

    </script>
</body>

</html>
